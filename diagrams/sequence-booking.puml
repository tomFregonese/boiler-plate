@startuml sequence-booking

participant Client
participant "API Gateway" as GW
participant "Cinemas Service" as Cinemas
participant "Movies Service" as Movies
participant "Bookings Service" as Bookings

== UC - Browse sessions by film (public) ==

Client -> GW : GET /api/cinemas/movies/:filmId/sessions
note right of GW : Public â€” forward with x-api-key only
GW -> Cinemas : GET /movies/:filmId/sessions\n(x-api-key)
Cinemas -> Movies : GET /movie/id/:filmId\n(X-Internal-Api-Key)
Movies --> Cinemas : 200 film details\n{ title, director, durationMinutes,\n  releaseYear, posterUrl, synopsis }
Cinemas --> GW : 200\n{ film, providers: [{ cinemaId, cinemaName,\n  sessions: [{ sessionId, startTime }] }] }
GW --> Client : 200 sessions by cinema

== UC - View seat map (public) ==

Client -> GW : GET /api/cinemas/sessions/:id/seats
GW -> Cinemas : GET /sessions/:id/seats\n(x-api-key)
Cinemas --> GW : 200\n{ sessionId, film,\n  rows: [{ rowName,\n    seats: [{ seatId, columnNumber,\n      status: FREE|OCCUPIED }] }] }
GW --> Client : 200 seat map

== UC - Create booking (protected) ==

Client -> GW : POST /api/bookings\n{ sessionId, seatIds,\n  payment: { provider, amount, currency } }\nAuthorization: Bearer {JWT}
GW -> GW : validate JWT (local)\nextract uid, roles[]
GW -> Bookings : POST /bookings\n{ sessionId, seatIds, payment }\nX-User-Id: {uid}\nX-Api-Key: {secret}
Bookings -> Cinemas : POST /sessions/:id/book\n{ seatIds }\nX-User-Id: {uid}\nX-Api-Key: {secret}
Cinemas -> Cinemas : atomic seat occupation\nmark seats OCCUPIED for userId
Cinemas --> Bookings : 204 No Content
Bookings -> Bookings : create Booking (PENDING)\ncreate BookingSeats\ncreate Payment (PENDING)
Bookings --> GW : 201\n{ id, userId, sessionId, status: PENDING,\n  seats, payment }
GW --> Client : 201 booking created

@enduml
